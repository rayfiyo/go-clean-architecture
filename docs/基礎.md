# クリーンアーキテクチャについてのメモ

## 大切なこと

短く説明したいので横暴に翻訳し，横暴に縮めている．各用語を調べることを推奨する．  
また，依存性逆転の原則（D）を含む SOLID 原則は [SOLID 原則完全に理解した！になるための本](https://zenn.dev/nakurei/books/solid-principle-kanzen-rikai) がわかりやすい [\*3](#3)

1. 関心の分離（Separation of Concerns）
   ✅️ ソフトウェアを異なる責務に基づいて層に分ける
   ✅️ 各層が独立して管理可能になる
2. 依存規則（The Dependency Rule）
   - 上位モジュールが下位モジュールに依存しない構造
     - 上位: 図の内側，上位レベル，方針
       - ビジネスルール
     - 下位: 図の外側，下位レベル，メカニズム
       - フレームワーク
       - データベース
3. 依存性逆転の原則（Dependency Inversion Principle）
   - 依存規則を守りながら，各層の境界をまたぐ実装を行うコンセプト
   - 言い換えると，上位モジュールと下位モジュールの双方が抽象的に知っている
     - 依存しないが知っている という状態にするために，抽象化するということ
   - ボブおじの右下の図に該当する
   - 具体的には，インターフェースで実装する
     - モジュールはもちろん，抽象自体が具体的な実装内容に依存してはいけない

## クリーンアーキテクチャに共通するもの [\*2](#2)

1. フレームワークの独立 Independent of Frameworks
   機能が豊富なライブラリやフレームワークの存在に依存しない  
   ✅️ それらの存在をツールとして利用できる  
   ✅️ システムをそれらの制約に合わせる必要がなくなる
2. テスト可能 Testable
   ビジネスルールは，UI，DB，Web サーバ などの外部要素なしにテストできる
3. UI の独立 Independent of UI
   UI を変更しても，システムの他の部分を変更する必要がない  
   例: Web UI を CLI に変更しても，ビジネスルールは影響しない
4. データベースの独立 Independent of Database
   DB を変更しても，システムの他の部分を変更する必要がない  
   ビジネスルールは DB に縛られない  
   例: MySQL から Mongo DB に変更しても，ビジネスルールは影響しない
5. 外部機能の独立 Independent of any external agency
   実際，あなたのビジネスルールは外部機関（外の世界）についてまったく何も知らないよね～

### 私の強い偏見メモ

- Independent of ~ なので，クリーンアーキテクチャ（のコード，の構造）を見るだけで，
  その独立が分かる必要がある．
- 依存しない は 知らない を内包する．知らない ⇒ 依存しない は真．
  しかし，依存しないは（知らないであるための）必要条件なので，
  依存しない ⇒ 知らない は真とは限らない．
  - 具体的には，内側（インターフェース層）が外側（フレームワーク層）の存在を
    知っていてもおかしくない．なお，**知っているだけで，依存はしない**．
  - 知らない
    - 実装詳細の情報をコードに全く持たない
    - 依存関係を注入することでのみ外部要素を利用できる
  - 依存しない（独立）
    - 抽象的には知っているが，具体的に依存しない
    - インターフェースやポリモーフィズムを用いることで，異なる実装に柔軟に対応
- 知る = 抽象的に依存する と解釈したほうがわかりやすい場面が多々ある気がする…
  - この抽象的にする（例えば Go だと Interface で実装）ことで，
    依存関係を逆転させることを，依存性逆転の原則という
- これらの概念を無理なく統合しようとする試みがクリーンアーキテクチャであって，
  その一例としてボブおじの図がある

## 層の例

ここでは，例としてボブおじさんのクリーンアーキテクチャを内側から順に取り上げる．
よく見る図は一番最後の[参考文献](#参考文献)に引用した．
なぜこのような層分けになったのかは省略する（基本的に依存規則を守るため）．

1. エンティティ層: Enterprise Business Rules
   - システム全体で再利用される
   - 外部システム（ナビゲーション，セキュリティ，運用変更など）の影響を受けない
   - 例: **大規模プロジェクト**の場合（企業など）
     - ビジネスルールをカプセル化したもの
     - 企業内で様々なアプリケーションから使用できる限りなんでも良い
       - メソッドを持ったオブジェクト
       - データ構造と関数の集合
   - 例: **単一アプリケーション**の場合
     - ビジネスオブジェクトをカプセル化したもの
       - 最も一般的で高レベルのルール
       - 外部が変化しても最も変更する可能性が低いもの
   - 含まれる例: ドメインモデル，バリューオブジェクト
2. ユースケース層: Application Business Rules
   - エンティティ層を活用して（ビジネスルールに基づき），
     アプリ固有のビジネスルールを実装する
   - システムのすべての使用事例（ユースケース）毎にサービスを分離しカプセル化
   - なお，アプリケーション操作の変更はユースケース詳細に影響を与えることがあり，
     その結果この層の一部に影響をもたらす．
   - 含まれる例: サービス，アプリケーションロジック
3. インターフェース層: Interface Adapters
   - 内側の層を外部の世界に接続
     - 「エンティティ層とユースケース層」と「DB や Web や 外部サービス など」間で
       それぞれで扱いやすい形式に変換するので，Interface Adapters という
     - つまり実装上，多少は外部について知る必要があるが，知っているだけ（依存しない）
     - 外部の詳細を内部に漏らしてはいけない，この層で吸収する
   - 逆に外側の層（DB など）はこの層に制限される
   - 例: モデルは次の流れのデータ構造
     - コントローラー -> ユースケース
     - ユースケース -> プレゼンターとビュー
   - 含まれる例: プレゼンター，ビュー（UI），コントローラー
4. フレームワーク層: Frameworks & Drivers
   - 詳細（具体）である，外部の技術スタックを管理するインフラ部分
     - フレームワーク，ツール，DB，Web フレームワーク
   - あんまりコードを書かない
     - 内側の円を次の円とつなげるコードとかくらい？
   - 含まれる例: リポジトリ，データベース接続

## 命名例

1. エンティティ層
   - `domain`: ドメイン駆動設計におけるドメインモデルの流れをくんでいる
     - エンティティ，値オブジェクト，ドメインサービス，ドメインイベントなども含む
     - entity より包括的なビジネスロジック全体に関連する要素を含む印象
   - `entity`: オブジェクト指向のエンティティ概念の流れをくんでいる
     - エンティティは一意の識別子を持ち，システムの中心的なデータ構造として扱う
     - ビジネスルールよりも，データモデルに焦点を当てている
2. ユースケース層
   - `usecase`
3. インターフェース層
   - `adapter`: Interface Adapters の後者派，橋渡し感がある
   - `interface`: Interface Adapters の前者派，境界感がある
   - `api`: まさに API としての作用に注目，１回しか見かけたことない…
     - HTTP サーバや，RESTful API エンドポイント，リクエスト/レスポンスの管理 など
4. フレームワーク層
   - `infrastructure`: インフラ
   - `framework`: 見ない．フレームワーク以外の DB や外部 API などを含まないからだと思う．

# 参考文献

## 1

- [The Clean Architecture - Clean Coder Blog](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
  - ボブおじさん（Robert C. Martin）のクリーンアキテクチャ
  - あの有名な図もここ
    ![ボブおじさんのクリーンアーキテクチャ図](./ボブおじさんのクリーンアーキテクチャ図.jpg)
  - 関連として同サイトのページを次に示しておく
    - [Clean Architecture - Clean Coder Blog](https://blog.cleancoder.com/uncle-bob/2011/11/22/Clean-Architecture.html)

## 2

- [クリーンアーキテクチャ(The Clean Architecture 翻訳) \_ blog.tai2.net](https://blog.tai2.net/the_clean_architecture.html)
  - 上サイト（ボブおじ）の日本語訳版

## 3

- [SOLID 原則完全に理解した！になるための本](https://zenn.dev/nakurei/books/solid-principle-kanzen-rikai)

## 4

https://qiita.com/ogady/items/34aae1b2af3080e0fec4
